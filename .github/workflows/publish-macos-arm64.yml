name: publish-macos-arm64

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: macos-latest

    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_NOLOGO: "1"

    steps:
      - name: Checkout xecrets-cli
        uses: actions/checkout@v4
        with:
          path: xecrets-cli
          fetch-depth: 1

      - name: Checkout xecrets-net
        uses: actions/checkout@v4
        with:
          repository: B38LU9J3/xecrets-net
          path: xecrets-net
          fetch-depth: 1

      - name: Checkout xecrets-slip39
        uses: actions/checkout@v4
        with:
          repository: B38LU9J3/xecrets-slip39
          path: xecrets-slip39
          fetch-depth: 1

      - name: Setup .NET SDK (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: xecrets-cli/global.json

      - name: Restore (solution)
        run: dotnet restore xecrets-cli/src/Xecrets.Cli.sln

      - name: Publish CLI (osx-arm64, self-contained)
        run: |
          dotnet publish xecrets-cli/src/Xecrets.Cli/Xecrets.Cli.csproj \
            -c Release \
            -r osx-arm64 \
            --self-contained true \
            -p:ContinuousIntegrationBuild=true \
            -o publish/osx-arm64 \
            --no-restore

      - name: Create tarball
        run: |
          cd publish
          tar -czf xecrets-cli-osx-arm64.tar.gz osx-arm64

      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: xecrets-cli-osx-arm64
          path: publish/xecrets-cli-osx-arm64.tar.gz
          retention-days: 14
